/*! 
 * quantize.js Copyright 2008 Nick Rabinowitz.
 * Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 */
if(!pv)var pv={map:function(a,b){var c={};return b?a.map(function(a,d){return c.index=d,b.call(c,a)}):a.slice()},naturalOrder:function(a,b){return b>a?-1:a>b?1:0},sum:function(a,b){var c={};return a.reduce(b?function(a,d,e){return c.index=e,a+b.call(c,d)}:function(a,b){return a+b},0)},max:function(a,b){return Math.max.apply(null,b?pv.map(a,b):a)}};var MMCQ=function(){function e(b,c,d){return(b<<2*a)+(c<<a)+d}function f(a){function d(){b.sort(a),c=!0}var b=[],c=!1;return{push:function(a){b.push(a),c=!1},peek:function(a){return c||d(),void 0===a&&(a=b.length-1),b[a]},pop:function(){return c||d(),b.pop()},size:function(){return b.length},map:function(a){return b.map(a)},debug:function(){return c||d(),b}}}function g(a,b,c,d,e,f,g){var h=this;h.r1=a,h.r2=b,h.g1=c,h.g2=d,h.b1=e,h.b2=f,h.histo=g}function h(){this.vboxes=new f(function(a,b){return pv.naturalOrder(a.vbox.count()*a.vbox.volume(),b.vbox.count()*b.vbox.volume())})}function i(c){var g,h,i,j,d=1<<3*a,f=Array(d);return c.forEach(function(a){h=a[0]>>b,i=a[1]>>b,j=a[2]>>b,g=e(h,i,j),f[g]=(f[g]||0)+1}),f}function j(a,c){var k,l,m,d=1e6,e=0,f=1e6,h=0,i=1e6,j=0;return a.forEach(function(a){k=a[0]>>b,l=a[1]>>b,m=a[2]>>b,d>k?d=k:k>e&&(e=k),f>l?f=l:l>h&&(h=l),i>m?i=m:m>j&&(j=m)}),new g(d,e,f,h,i,j,c)}function k(a,b){function p(a){var e,f,g,l,m,c=a+"1",d=a+"2",n=0;for(k=b[c];b[d]>=k;k++)if(i[k]>h/2){for(g=b.copy(),l=b.copy(),e=k-b[c],f=b[d]-k,m=f>=e?Math.min(b[d]-1,~~(k+f/2)):Math.max(b[c],~~(k-1-e/2));!i[m];)m++;for(n=j[m];!n&&i[m-1];)n=j[--m];return g[d]=m,l[c]=g[d]+1,console.log("vbox counts:",b.count(),g.count(),l.count()),[g,l]}}if(b.count()){var c=b.r2-b.r1+1,d=b.g2-b.g1+1,f=b.b2-b.b1+1,g=pv.max([c,d,f]);if(1==b.count())return[b.copy()];var k,l,m,n,o,h=0,i=[],j=[];if(g==c)for(k=b.r1;b.r2>=k;k++){for(n=0,l=b.g1;b.g2>=l;l++)for(m=b.b1;b.b2>=m;m++)o=e(k,l,m),n+=a[o]||0;h+=n,i[k]=h}else if(g==d)for(k=b.g1;b.g2>=k;k++){for(n=0,l=b.r1;b.r2>=l;l++)for(m=b.b1;b.b2>=m;m++)o=e(l,k,m),n+=a[o]||0;h+=n,i[k]=h}else for(k=b.b1;b.b2>=k;k++){for(n=0,l=b.r1;b.r2>=l;l++)for(m=b.g1;b.g2>=m;m++)o=e(l,m,k),n+=a[o]||0;h+=n,i[k]=h}return i.forEach(function(a,b){j[b]=h-a}),g==c?p("r"):g==d?p("g"):p("b")}}function l(b,e){function p(a,b){for(var f,d=1,e=0;c>e;)if(f=a.pop(),f.count()){var h=k(g,f),i=h[0],j=h[1];if(!i)return console.log("vbox1 not defined; shouldn't happen!"),void 0;if(a.push(i),j&&(a.push(j),d++),d>=b)return;if(e++>c)return console.log("infinite loop; perhaps too few pixels!"),void 0}else a.push(f),e++}if(!b.length||2>e||e>256)return console.log("wrong number of maxcolors"),!1;var g=i(b),m=0;g.forEach(function(){m++});var n=j(b,g),o=new f(function(a,b){return pv.naturalOrder(a.count(),b.count())});o.push(n),p(o,d*e);for(var q=new f(function(a,b){return pv.naturalOrder(a.count()*a.volume(),b.count()*b.volume())});o.size();)q.push(o.pop());p(q,e-q.size());for(var r=new h;q.size();)r.push(q.pop());return r}var a=5,b=8-a,c=1e3,d=.75;return g.prototype={volume:function(a){var b=this;return(!b._volume||a)&&(b._volume=(b.r2-b.r1+1)*(b.g2-b.g1+1)*(b.b2-b.b1+1)),b._volume},count:function(a){var b=this,c=b.histo;if(!b._count_set||a){var f,g,h,d=0;for(f=b.r1;b.r2>=f;f++)for(g=b.g1;b.g2>=g;g++)for(h=b.b1;b.b2>=h;h++)index=e(f,g,h),d+=c[index]||0;b._count=d,b._count_set=!0}return b._count},copy:function(){var a=this;return new g(a.r1,a.r2,a.g1,a.g2,a.b1,a.b2,a.histo)},avg:function(b){var c=this,d=c.histo;if(!c._avg||b){var k,l,m,n,o,f=0,g=1<<8-a,h=0,i=0,j=0;for(l=c.r1;c.r2>=l;l++)for(m=c.g1;c.g2>=m;m++)for(n=c.b1;c.b2>=n;n++)o=e(l,m,n),k=d[o]||0,f+=k,h+=k*(l+.5)*g,i+=k*(m+.5)*g,j+=k*(n+.5)*g;f?c._avg=[~~(h/f),~~(i/f),~~(j/f)]:(console.log("empty box"),c._avg=[~~(g*(c.r1+c.r2+1)/2),~~(g*(c.g1+c.g2+1)/2),~~(g*(c.b1+c.b2+1)/2)])}return c._avg},contains:function(a){var c=this,d=a[0]>>b;return gval=a[1]>>b,bval=a[2]>>b,d>=c.r1&&c.r2>=d&&gval>=c.g1&&c.g2>=d&&bval>=c.b1&&c.b2>=d}},h.prototype={push:function(a){this.vboxes.push({vbox:a,color:a.avg()})},palette:function(){return this.vboxes.map(function(a){return a.color})},size:function(){return this.vboxes.size()},map:function(a){for(var b=this.vboxes,c=0;b.size()>c;c++)if(b.peek(c).vbox.contains(a))return b.peek(c).color;return this.nearest(a)},nearest:function(a){for(var c,d,e,b=this.vboxes,f=0;b.size()>f;f++)d=Math.sqrt(Math.pow(a[0]-b.peek(f).color[0],2)+Math.pow(a[1]-b.peek(f).color[1],2)+Math.pow(a[1]-b.peek(f).color[1],2)),(c>d||void 0===c)&&(c=d,e=b.peek(f).color);return e},forcebw:function(){var a=this.vboxes;a.sort(function(a,b){return pv.naturalOrder(pv.sum(a.color),pv.sum(b.color))});var b=a[0].color;5>b[0]&&5>b[1]&&5>b[2]&&(a[0].color=[0,0,0]);var c=a.length-1,d=a[c].color;d[0]>251&&d[1]>251&&d[2]>251&&(a[c].color=[255,255,255])}},{quantize:l}}();